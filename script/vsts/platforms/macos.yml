jobs:
  - job: macOS_build
    displayName: macOS Build
    dependsOn: GetReleaseVersion
    timeoutInMinutes: 180

    variables:
      ReleaseVersion: $[ dependencies.GetReleaseVersion.outputs['Version.ReleaseVersion'] ]
      IsReleaseBranch: $[ dependencies.GetReleaseVersion.outputs['Version.IsReleaseBranch'] ]
      IsSignedZipBranch: $[ dependencies.GetReleaseVersion.outputs['Version.IsSignedZipBranch'] ]
      RunCoreMainTests: true
    pool:
      vmImage: macos-10.15

    steps:
      - template: templates/preparation.yml

      - template: templates/cache.yml
        parameters:
          OS: macos

      - template: templates/bootstrap.yml

      - template: templates/build.yml

      # core main tests
      - template: templates/test.yml

      - script: |
          cp $(Build.SourcesDirectory)/out/*.zip $(Build.ArtifactStagingDirectory)
        displayName: Stage Artifacts

      - template: templates/publish.yml
        parameters:
          artifacts:
            - fileName: atom-mac.zip
              fileDir: $(Build.ArtifactStagingDirectory)
              condition: succeeded()
            - fileName: atom-mac-symbols.zip
              fileDir: $(Build.ArtifactStagingDirectory)
              condition: succeeded()
            - fileName: atom-api.json
              fileDir: $(Build.SourcesDirectory)/docs/output
              condition: succeeded()

  - job: macOS_tests
    displayName: macOS Tests
    dependsOn: macOS_build
    timeoutInMinutes: 180
    pool:
      vmImage: macos-10.15
    strategy:
      maxParallel: 3
      matrix:
        renderer:
          RunCoreRendererTests: true
          RunPackageTests: false
        packages-1:
          RunCoreTests: false
          RunPackageTests: 1
          ATOM_PACKAGES_TO_SKIP: "github"
        packages-2:
          RunCoreTests: false
          RunPackageTests: 2

    steps:
      - template: templates/preparation.yml

      - template: templates/cache.yml
        parameters:
          OS: macos

      # The artifact caching task does not work on forks, so we need to
      # bootstrap again for pull requests coming from forked repositories.
      - template: templates/bootstrap.yml

      - template: templates/download-unzip.yml
        parameters:
          artifacts:
            - atom-mac.zip
            - atom-mac-symbols.zip

      - template: templates/test.yml

  - job: macOS_tests_github
    displayName: macOS Tests github
    dependsOn: macOS_build
    timeoutInMinutes: 180
    pool:
      vmImage: macos-10.15
    variables:
      ATOM_RESOURCE_PATH: $(Build.SourcesDirectory)
      CI: true
      MOCHA_TIMEOUT: 60000
      UNTIL_TIMEOUT: 30000
    steps:
      - template: templates/preparation.yml

      - template: templates/cache.yml
        parameters:
          OS: macos

      # The artifact caching task does not work on forks, so we need to
      # bootstrap again for pull requests coming from forked repositories.
      - template: templates/bootstrap.yml

      - template: templates/download-unzip.yml
        parameters:
          artifacts:
            - atom-mac.zip
            - atom-mac-symbols.zip

      - pwsh: |
          cd $(Build.SourcesDirectory)/node_modules/github
          $(Build.SourcesDirectory)/apm/node_modules/.bin/apm install
        displayName: Prepare test dependencies for package
        condition: and(succeeded(), ne(variables['Atom.SkipTests'], 'true'))

      - pwsh: |
          echo CI env var is set to: $env:CI
          echo MOCHA_TIMOUT env var is set to: $env:MOCHA_TIMEOUT
          echo UNTIL_TIMOUT env var is set to: $env:MOCHA_TIMEOUT
          $(Build.SourcesDirectory)/out/Atom*.app/Contents/MacOS/Atom* --resource-path $(Build.SourcesDirectory) --test $(Build.SourcesDirectory)/node_modules/github/test
        displayName: Run tests
        condition: and(succeeded(), ne(variables['Atom.SkipTests'], 'true'))
        env:
          CI: true
          MOCHA_TIMEOUT: 60000
          UNTIL_TIMEOUT: 30000

      - pwsh: |
          echo CI env var is set to: $env:CI
          echo MOCHA_TIMOUT env var is set to: $env:MOCHA_TIMEOUT
          echo UNTIL_TIMOUT env var is set to: $env:MOCHA_TIMEOUT
          $(Build.SourcesDirectory)/out/Atom*.app/Contents/MacOS/Atom* --resource-path $(Build.SourcesDirectory) --test $(Build.SourcesDirectory)/node_modules/github/test
        displayName: Run tests
        condition: and(succeeded(), ne(variables['Atom.SkipTests'], 'true'))
