steps:

  # Linux Specific
  - script: sudo /sbin/start-stop-daemon --start --quiet --pidfile /tmp/custom_xvfb_99.pid --make-pidfile --background --exec /usr/bin/Xvfb -- :99 -ac -screen 0 1280x1024x16
    displayName: Start Xvfb
    condition: eq(variables['Agent.OS'], 'Linux')

  # Common
  - task: NodeTool@0
    inputs:
      versionSpec: 12.16.x
    displayName: Install Node.js 12.16.x
    # Most-recent version of Node 12 we can use without running into this:
    # https://github.com/babel/babel/issues/11216
    # Todo: Upgrade babel to 7.8.7 or newer, everywhere in Atom, so we can use newer Node.
    #
    # Happens due to: ECMAScript Modules feature in Node
    # https://github.com/nodejs/node/pull/29866
    #
    # https://github.com/nodejs/node/blob/master/doc/changelogs/CHANGELOG_V12.md#12.17.0
    # https://github.com/nodejs/node/blob/master/doc/changelogs/CHANGELOG_V13.md#13.2.0
    # https://github.com/nodejs/node/blob/master/doc/changelogs/CHANGELOG_V14.md#14.0.0

  # Windows Specific
  - pwsh: |
      if ($env:AGENT_OS -eq "Windows_NT") {
        $env:BUILD_ARCH=$env:buildArch
        echo "##vso[task.setvariable variable=BUILD_ARCH]$env:BUILD_ARCH" # Azure syntax
      }
      echo BUILD_ARCH: $env:BUILD_ARCH
    displayName: Setting globally used env variables

  - script: |
      npm install --global --production windows-build-tools@4.0
    displayName: Install windows build tools
    condition: eq(variables['Agent.OS'], 'Windows_NT')

  - script: |
      cd script\vsts
      npm install
    displayName: Install Windows build dependencies
    condition: eq(variables['Agent.OS'], 'Windows_NT')
