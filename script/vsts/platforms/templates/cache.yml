parameters:
  - name: OS
    displayName: Operating System
    type: string
    values:
      - windows
      - linux
      - macos

steps:
  - task: Cache@2
    displayName: Cache apm/node_modules
    inputs:
      key: 'npm | "$(Agent.OS)" | "$(BUILD_ARCH)" | apm/package.json, apm/package-lock.json, script/vsts/platforms/${{ parameters.OS }}.ym, script/vsts/platforms/preparation.yml'
      path: 'apm/node_modules'
      cacheHitVar: ApmNodeModulesRestored

  - task: Cache@2
    displayName: Cache script/node_modules
    condition: eq(variables.ApmNodeModulesRestored, true)
    inputs:
      key: 'npm | "$(Agent.OS)" | "$(BUILD_ARCH)" | script/package.json, script/package-lock.json, package.json, package-lock.json, script/vsts/platforms/${{ parameters.OS }}.yml, script/vsts/platforms/preparation.yml'
      path: 'script/node_modules'
      cacheHitVar: ScriptNodeModulesRestored

  - task: Cache@2
    displayName: Cache node_modules
    condition: eq(variables.ScriptNodeModulesRestored, true)
    inputs:
      key: 'npm | "$(Agent.OS)" | "$(BUILD_ARCH)" | script/package.json, script/package-lock.json, package.json, package-lock.json, script/vsts/platforms/${{ parameters.OS }}.yml, script/vsts/platforms/preparation.yml'
      path: 'node_modules'
      cacheHitVar: MainNodeModulesRestored
