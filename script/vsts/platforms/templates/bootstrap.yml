steps:
  - pwsh: |
      # OS specific env variables
      if ($env:AGENT_OS -eq "Windows_NT") {
        $env:NPM_BIN_PATH="C:/hostedtoolcache/windows/node/12.13.1/x64/npm.cmd"
        $env:npm_config_build_from_source=true
      }
      if ($env:AGENT_OS -eq "Darwin") {
        $env:NPM_BIN_PATH="/usr/local/bin/npm"
        $env:npm_config_build_from_source=true
      }
      if ($env:AGENT_OS -eq "Linux") {
        $env:NPM_BIN_PATH="/usr/local/bin/npm"
        $env:CC=clang
        $env:CXX=clang++
        $env:npm_config_clang=1
      }

      # Bootstrap
      if (($env:AGENT_OS  -eq "Windows_NT") -and ($env:BUILD_ARCH -eq "x86")) {
        node 'script\vsts\windows-run.js' 'script\bootstrap.cmd'
      }
      else {
        script/bootstrap
      }
    displayName: Bootstrap build environment
    env:
      GITHUB_TOKEN: $(GITHUB_TOKEN)
      CI: true
      CI_PROVIDER: VSTS
    condition: ne(variables['CacheRestored'], 'true')

  - task: 1ESLighthouseEng.PipelineArtifactCaching.SaveCacheV1.SaveCache@1
    displayName: Save node_modules cache (Windows)
    inputs:
      keyfile: 'package.json, script/vsts/platforms/${{ parameters.OS }}.yml, **/package-lock.json, !**/node_modules/**/package-lock.json, !**/.*/**/package-lock.json, script/vsts/${{ variables.buildArch }}-cache-key'
      targetfolder: '**/node_modules, !**/node_modules/**/node_modules'
      vstsFeed: 'c4ca4bc0-0579-40b1-ac88-906ed61131cd'
    condition: and(ne(variables['CacheRestored'], 'true'), eq(variables['Agent.OS'], 'Windows_NT'))

  - task: 1ESLighthouseEng.PipelineArtifactCaching.SaveCacheV1.SaveCache@1
    displayName: Save node_modules cache
    inputs:
      keyfile: 'package.json, script/vsts/platforms/${{ parameters.OS }}.yml, **/package-lock.json, !**/node_modules/**/package-lock.json, !**/.*/**/package-lock.json'
      targetfolder: '**/node_modules, !**/node_modules/**/node_modules'
      vstsFeed: 'c4ca4bc0-0579-40b1-ac88-906ed61131cd'
    condition: and(ne(variables['CacheRestored'], 'true'), ne(variables['Agent.OS'], 'Windows_NT'))
